<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DeCharge DeGen Energy Terminal – Mark1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#020617;
      --bg-elevated:rgba(15,23,42,.96);
      --border-soft:rgba(148,163,184,.35);
      --primary:#0ea5e9;
      --primary-soft:rgba(14,165,233,.18);
      --accent:#22c55e;
      --accent-soft:rgba(34,197,94,.16);
      --purple:#a855f7;
      --text-main:#e5e7eb;
      --text-muted:#9ca3af;
      --danger:#f97373;
      --card-radius:18px;
    }

    *{box-sizing:border-box}
    body{
      margin:0; padding:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"SF Pro Text",sans-serif;
      background:
        radial-gradient(circle at top left, rgba(56,189,248,.15), transparent 55%),
        radial-gradient(circle at top right, rgba(129,140,248,.18), transparent 55%),
        radial-gradient(circle at bottom, rgba(34,197,94,.12), transparent 55%),
        var(--bg);
      color:var(--text-main);
      min-height:100vh;
    }

    .shell{max-width:1400px;margin:0 auto;padding:20px 20px 32px}

    header{
      display:flex; align-items:center; justify-content:space-between;
      margin-bottom:18px; gap:16px;
    }

    .brand{display:flex;flex-direction:column;gap:4px}
    .brand-title{
      font-size:1.4rem;font-weight:700;letter-spacing:.06em;text-transform:uppercase;
      display:inline-flex;align-items:center;gap:8px;
    }
    .brand-pill{
      font-size:.75rem;padding:2px 8px;border-radius:999px;
      border:1px solid rgba(148,163,184,.5);
      text-transform:uppercase;letter-spacing:.08em;color:var(--text-muted);
    }
    .brand-dot{
      width:10px;height:10px;border-radius:999px;
      background:radial-gradient(circle at 30% 20%, #e5f9ff, #22c55e);
      box-shadow:0 0 14px rgba(34,197,94,.85);
    }
    .brand-sub{font-size:.9rem;color:var(--text-muted)}

    .header-right{
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end;
    }
    .badge{
      padding:6px 10px;border-radius:999px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.6);
      font-size:.75rem;display:inline-flex;align-items:center;gap:6px;
    }
    .badge span.key{
      text-transform:uppercase;letter-spacing:.08em;
      color:var(--text-muted);font-size:.7rem;
    }
    .badge span.value{font-weight:600}
    .badge.degen{
      border-color:var(--primary);
      background:linear-gradient(120deg, rgba(15,23,42,.9), rgba(8,47,73,.95));
    }

    .grid{
      display:grid;
      grid-template-columns:2fr 1.2fr;
      grid-template-rows:auto auto;
      gap:16px;
      margin-top:14px;
    }
    @media (max-width:1024px){ .grid{grid-template-columns:1fr;} }

    .card{
      background:var(--bg-elevated);
      border-radius:var(--card-radius);
      border:1px solid var(--border-soft);
      box-shadow:0 18px 60px rgba(15,23,42,.9), 0 0 0 1px rgba(15,23,42,.8);
      padding:14px 16px 16px;
      position:relative;
      overflow:hidden;
    }
    .card::before{
      content:""; position:absolute; inset:0; pointer-events:none;
      background:radial-gradient(circle at top left, rgba(56,189,248,.12), transparent 60%);
      opacity:.7;
    }

    .card-header{
      display:flex;justify-content:space-between;align-items:center;
      gap:8px;margin-bottom:10px;
    }
    .card-title{
      font-size:.85rem;text-transform:uppercase;letter-spacing:.14em;color:var(--text-muted);
    }
    .pill{
      font-size:.7rem;text-transform:uppercase;letter-spacing:.12em;
      padding:3px 8px;border-radius:999px;border:1px solid rgba(148,163,184,.5);
      color:var(--text-muted);
    }
    .pill.primary{border-color:var(--primary);color:var(--primary);background:rgba(8,47,73,.8)}
    .pill.accent{border-color:var(--accent);color:var(--accent);background:rgba(5,46,22,.85)}

    .metrics-row{
      display:grid;
      grid-template-columns:repeat(4,minmax(0,1fr));
      gap:10px;
    }
    @media (max-width:768px){ .metrics-row{grid-template-columns:repeat(2,minmax(0,1fr));} }

    .metric-tile{
      background:radial-gradient(circle at top, rgba(15,23,42,.4), rgba(15,23,42,.9));
      border-radius:14px;padding:8px 10px;
      border:1px solid rgba(30,64,175,.7);
      display:flex;flex-direction:column;gap:4px;
    }
    .metric-label{font-size:.7rem;text-transform:uppercase;letter-spacing:.16em;color:var(--text-muted)}
    .metric-value{font-size:1.1rem;font-weight:600}
    .metric-sub{font-size:.7rem;color:var(--text-muted)}
    .metric-highlight{color:var(--accent)}

    /* ✅ this is the key: hard heights + grid always visible */
    .charts-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      align-items:stretch;
    }
    @media (max-width:1024px){ .charts-grid{grid-template-columns:1fr;} }

    .chart-card{
      background:rgba(15,23,42,.55);
      border-radius:14px;
      padding:10px 12px;
      border:1px solid rgba(51,65,85,.65);
      position:relative;
      overflow:hidden;
      min-height:240px;              /* ✅ ensures box itself shows */
    }
    .chart-card.small{min-height:210px;}
    .mini-title{
      font-size:.72rem;
      text-transform:uppercase;
      letter-spacing:.14em;
      color:var(--text-muted);
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
    }
    .mini-badge{
      font-size:.68rem;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.5);
      color:var(--text-muted);
      background:rgba(2,6,23,.25);
    }

    /* ✅ force canvas to have a visible drawing area */
    .chart-wrap{height:200px;}
    .chart-wrap.big{height:260px;}
    canvas{width:100% !important; height:100% !important; display:block;}

    /* Revenue panel (same as before) */
    .revenue-grid{display:grid;grid-template-columns:1.3fr 1fr;gap:10px}
    @media (max-width:768px){ .revenue-grid{grid-template-columns:1fr;} }
    .rev-main{
      background:radial-gradient(circle at top, var(--primary-soft), rgba(15,23,42,.95));
      border-radius:14px;padding:10px 12px;border:1px solid rgba(56,189,248,.55);
      display:flex;flex-direction:column;gap:6px;
    }
    .rev-main-title{font-size:.75rem;text-transform:uppercase;letter-spacing:.14em;color:var(--text-muted)}
    .rev-main-value{font-size:1.8rem;font-weight:700}
    .rev-main-sub{font-size:.75rem;color:var(--text-muted)}
    .rev-split{display:flex;gap:8px;margin-top:4px}
    .rev-chip{
      flex:1;border-radius:999px;padding:5px 9px;border:1px solid rgba(148,163,184,.6);
      font-size:.7rem;display:flex;justify-content:space-between;align-items:center;color:var(--text-muted);
    }
    .rev-chip span.value{color:var(--accent);font-weight:600}
    .rev-side{
      background:radial-gradient(circle at top, var(--accent-soft), rgba(15,23,42,.97));
      border-radius:14px;padding:10px 12px;border:1px solid rgba(34,197,94,.55);
      display:flex;flex-direction:column;gap:6px;font-size:.8rem;
    }
    .rev-side-title{ text-transform:uppercase;letter-spacing:.14em;color:var(--text-muted);font-size:.72rem; }
    .rev-side-row{display:flex;justify-content:space-between;align-items:center}
    .rev-side-row span.value{font-weight:600;color:var(--accent)}

    footer{
      margin-top:10px;
      font-size:.7rem;
      color:var(--text-muted);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
  </style>
</head>

<body>
  <div class="shell">
    <header>
      <div class="brand">
        <div class="brand-title">
          <span class="brand-dot"></span>
          DeCharge DeGen Energy Terminal
          <span class="brand-pill">Mark1</span>
        </div>
        <div class="brand-sub">Live simulated EV energy + revenue feed for the DeCharge network.</div>
      </div>
      <div class="header-right">
        <div class="badge degen"><span class="key">Mode</span><span class="value" id="modeLabel">office</span></div>
        <div class="badge"><span class="key">Sim Time</span><span class="value" id="simTime">00:00:00</span></div>
        <div class="badge"><span class="key">Sessions / Min</span><span class="value" id="arrivalsPerMin">0.00</span></div>
        <div class="badge"><span class="key">Corr</span><span class="value" id="corrValue">0.00</span></div>
      </div>
    </header>

    <div class="card">
      <div class="metrics-row">
        <div class="metric-tile">
          <div class="metric-label">Network Load</div>
          <div class="metric-value metric-highlight" id="totalKW">0.0 kW</div>
          <div class="metric-sub">Instantaneous charging power</div>
        </div>
        <div class="metric-tile">
          <div class="metric-label">Energy Dispensed (Sim Day)</div>
          <div class="metric-value" id="energyKWh">0.00 MWh</div>
          <div class="metric-sub">Target: <span id="targetKWh">0</span> kWh</div>
        </div>
        <div class="metric-tile">
          <div class="metric-label">Active Vehicles</div>
          <div class="metric-value" id="activeVehicles">0</div>
          <div class="metric-sub">Currently drawing power</div>
        </div>
        <div class="metric-tile">
          <div class="metric-label">FOMO Signal</div>
          <div class="metric-value" id="fomoSignal">Loading…</div>
          <div class="metric-sub" id="fomoSub">Calibrating regime.</div>
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- Left: 4 charts -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">Network State · Real-time Signals</div>
          <div class="pill primary">4 Live Charts</div>
        </div>

        <div class="charts-grid">
          <div class="chart-card">
            <div class="mini-title"><span>Power + Occupancy</span><span class="mini-badge">kW · active</span></div>
            <div class="chart-wrap big"><canvas id="chartPowerOcc"></canvas></div>
          </div>

          <div class="chart-card small">
            <div class="mini-title"><span>Arrival Velocity</span><span class="mini-badge">sessions/min</span></div>
            <div class="chart-wrap"><canvas id="chartArrivals"></canvas></div>
          </div>

          <div class="chart-card small">
            <div class="mini-title"><span>Energy Progress</span><span class="mini-badge">% of target</span></div>
            <div class="chart-wrap"><canvas id="chartEnergy"></canvas></div>
          </div>

          <div class="chart-card small">
            <div class="mini-title"><span>FOMO Heat</span><span class="mini-badge">corr + momentum</span></div>
            <div class="chart-wrap"><canvas id="chartFomo"></canvas></div>
          </div>
        </div>
      </div>

      <!-- Right: revenue -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">Network Revenue</div>
          <div class="pill accent">$0.004 / kWh · 20% protocol</div>
        </div>

        <div class="revenue-grid">
          <div class="rev-main">
            <div class="rev-main-title">Revenue in Last 60 Seconds (sim)</div>
            <div class="rev-main-value">$<span id="revLast60">0.00</span></div>
            <div class="rev-main-sub">
              Protocol fees:
              <span style="color:var(--accent);font-weight:600;">$<span id="revLast60Protocol">0.00</span></span>
            </div>
            <div class="rev-split">
              <div class="rev-chip"><span>To Hosts + LPs</span><span class="value">$<span id="revLast60Hosts">0.00</span></span></div>
              <div class="rev-chip"><span>To Protocol</span><span class="value">$<span id="revLast60ProtocolChip">0.00</span></span></div>
            </div>
          </div>

          <div class="rev-side">
            <div class="rev-side-title">Cumulative Margins</div>
            <div class="rev-side-row"><span>Total Margin (All Time)</span><span class="value">$<span id="revLifetime">0.00</span></span></div>
            <div class="rev-side-row"><span>Protocol Fees (All Time)</span><span class="value">$<span id="revLifetimeProtocol">0.00</span></span></div>
            <div class="rev-side-row" style="margin-top:4px;"><span style="color:var(--text-muted);">Est. Daily at Current Rate</span><span class="value">$<span id="revDailyAtRate">0.00</span></span></div>
          </div>
        </div>
      </div>
    </div>

    <footer>
      <span>Powered by DeCharge · DeGen Energy Terminal · Mark1</span>
      <span>Data simulated on backend, shared globally via Redis snapshot.</span>
    </footer>
  </div>

  <script>
    const API_BASE = "https://dtermnal.onrender.com";
    const MAX_POINTS = 240;

    let chartPowerOcc, chartArrivals, chartEnergy, chartFomo;

    const aux = { labels: [], arrivals: [], energyPct: [], corr: [], heat: [] };

    function formatNumber(v, d=2){
      const n = Number(v);
      if (!Number.isFinite(n)) return (0).toFixed(d);
      return n.toFixed(d);
    }
    function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }

    function createLineChart(canvasId, datasets, scales){
      const ctx = document.getElementById(canvasId).getContext("2d");
      return new Chart(ctx, {
        type: "line",
        data: { labels: [], datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: false,
          elements: { point: { radius: 0 } },
          scales,
          plugins: {
            legend: { labels: { color: "rgba(209,213,219,0.9)" } }
          }
        }
      });
    }

    function initCharts(){
      chartPowerOcc = createLineChart("chartPowerOcc",
        [
          { label:"Power (kW)", data:[], borderColor:"#0ea5e9", borderWidth:2, tension:.25, yAxisID:"y1" },
          { label:"Active Vehicles", data:[], borderColor:"#22c55e", borderWidth:1.5, borderDash:[4,3], tension:.25, yAxisID:"y2" }
        ],
        {
          x: { ticks:{ color:"rgba(148,163,184,0.9)", maxTicksLimit:6 }, grid:{ color:"rgba(30,64,175,0.25)" } },
          y1:{ position:"left", ticks:{ color:"#0ea5e9" }, grid:{ color:"rgba(30,64,175,0.25)" } },
          y2:{ position:"right", ticks:{ color:"#22c55e" }, grid:{ drawOnChartArea:false } }
        }
      );

      chartArrivals = createLineChart("chartArrivals",
        [{ label:"Arrivals / min", data:[], borderColor:"#a855f7", borderWidth:2, tension:.25 }],
        {
          x: { ticks:{ color:"rgba(148,163,184,0.9)", maxTicksLimit:6 }, grid:{ color:"rgba(30,64,175,0.18)" } },
          y: { ticks:{ color:"rgba(229,231,235,0.85)" }, grid:{ color:"rgba(30,64,175,0.18)" } }
        }
      );

      chartEnergy = createLineChart("chartEnergy",
        [{ label:"Energy Progress (%)", data:[], borderColor:"#22c55e", borderWidth:2, tension:.25 }],
        {
          x: { ticks:{ color:"rgba(148,163,184,0.9)", maxTicksLimit:6 }, grid:{ color:"rgba(30,64,175,0.18)" } },
          y: {
            min:0, max:100,
            ticks:{ color:"rgba(229,231,235,0.85)", callback:(v)=>v+"%" },
            grid:{ color:"rgba(30,64,175,0.18)" }
          }
        }
      );

      chartFomo = createLineChart("chartFomo",
        [
          { label:"FOMO Heat", data:[], borderColor:"#f97373", borderWidth:2, tension:.25 },
          { label:"Correlation", data:[], borderColor:"#0ea5e9", borderWidth:1.25, borderDash:[5,4], tension:.25 }
        ],
        {
          x: { ticks:{ color:"rgba(148,163,184,0.9)", maxTicksLimit:6 }, grid:{ color:"rgba(30,64,175,0.18)" } },
          y: { ticks:{ color:"rgba(229,231,235,0.85)" }, grid:{ color:"rgba(30,64,175,0.18)" } }
        }
      );
    }

    function momentum(arr){
      const n = arr.length;
      if (n < 8) return 0;
      const last = arr[n-1];
      const window = arr.slice(Math.max(0, n-20));
      const avg = window.reduce((a,b)=>a+b,0)/Math.max(1,window.length);
      return last-avg;
    }

    function pushAux(label, a, ePct, c, heat){
      aux.labels.push(label);
      aux.arrivals.push(a);
      aux.energyPct.push(ePct);
      aux.corr.push(c);
      aux.heat.push(heat);
      if (aux.labels.length > MAX_POINTS){
        aux.labels.shift(); aux.arrivals.shift(); aux.energyPct.shift(); aux.corr.shift(); aux.heat.shift();
      }
    }

    function updateCharts(series, now){
      const t = Array.isArray(series.t) ? series.t : [];
      const pkw = Array.isArray(series.pkw) ? series.pkw : [];
      const oi = Array.isArray(series.oi) ? series.oi : [];
      const n = Math.min(t.length, pkw.length, oi.length);
      if (n < 2) return;

      const start = Math.max(0, n - MAX_POINTS);
      const labels = t.slice(start, n).map(v => `${Math.round(Number(v)||0)}m`);
      const p = pkw.slice(start, n).map(Number);
      const o = oi.slice(start, n).map(Number);

      chartPowerOcc.data.labels = labels;
      chartPowerOcc.data.datasets[0].data = p;
      chartPowerOcc.data.datasets[1].data = o;
      chartPowerOcc.update("none");

      const arrivalsPerMin = Number(now.arrivalsPerMin) || 0;
      const energyKWh = Number(now.energyKWh) || 0;
      const targetKWh = Math.max(1, Number(now.targetKWh) || 1);
      const energyPct = clamp((energyKWh/targetKWh)*100, 0, 100);
      const corr = Number(now.corr) || 0;

      const mom = momentum(aux.arrivals);
      const heat = (corr*1.2) + (mom*0.35) + (arrivalsPerMin*0.10);
      pushAux(labels[labels.length-1], arrivalsPerMin, energyPct, corr, heat);

      chartArrivals.data.labels = aux.labels;
      chartArrivals.data.datasets[0].data = aux.arrivals;
      chartArrivals.update("none");

      chartEnergy.data.labels = aux.labels;
      chartEnergy.data.datasets[0].data = aux.energyPct;
      chartEnergy.update("none");

      chartFomo.data.labels = aux.labels;
      chartFomo.data.datasets[0].data = aux.heat;
      chartFomo.data.datasets[1].data = aux.corr;
      chartFomo.update("none");
    }

    function updateRevenue(rev){
      rev = rev || {};
      const last60 = Number(rev.last60sUSD)||0;
      const last60Prot = Number(rev.last60sProtocolUSD)||0;
      const lifetime = Number(rev.lifetimeUSD)||0;
      const lifetimeProt = Number(rev.lifetimeProtocolUSD)||0;

      document.getElementById("revLast60").textContent = formatNumber(last60,4);
      document.getElementById("revLast60Protocol").textContent = formatNumber(last60Prot,4);
      document.getElementById("revLast60ProtocolChip").textContent = formatNumber(last60Prot,4);
      document.getElementById("revLast60Hosts").textContent = formatNumber(last60-last60Prot,4);

      document.getElementById("revLifetime").textContent = formatNumber(lifetime,2);
      document.getElementById("revLifetimeProtocol").textContent = formatNumber(lifetimeProt,2);

      document.getElementById("revDailyAtRate").textContent = formatNumber(last60*60*24,2);
    }

    function updateMeta(now, cfg){
      document.getElementById("modeLabel").textContent = cfg.mode || "office";
      document.getElementById("simTime").textContent = now.simTime || "00:00:00";
      document.getElementById("arrivalsPerMin").textContent = formatNumber(now.arrivalsPerMin||0,2);
      document.getElementById("corrValue").textContent = formatNumber(now.corr||0,2);

      document.getElementById("totalKW").textContent = formatNumber(now.totalKW||0,1) + " kW";
      const energyMWh = (Number(now.energyKWh)||0)/1000.0;
      document.getElementById("energyKWh").textContent = formatNumber(energyMWh,3) + " MWh";
      document.getElementById("targetKWh").textContent = formatNumber(now.targetKWh||0,0);
      document.getElementById("activeVehicles").textContent = now.activeVehicles || 0;

      const corr = Number(now.corr)||0;
      const a = Number(now.arrivalsPerMin)||0;
      const heat = (corr*1.2) + (momentum(aux.arrivals)*0.35) + (a*0.10);

      const fomo = document.getElementById("fomoSignal");
      const fsub = document.getElementById("fomoSub");
      if (heat > 2.2){ fomo.textContent="Hot Zone"; fomo.style.color="var(--danger)"; fsub.textContent="High-yield wave forming. Watch the curve."; }
      else if (heat > 1.2){ fomo.textContent="Spiking"; fomo.style.color="var(--primary)"; fsub.textContent="Arrivals accelerating. Utilization is clustering."; }
      else { fomo.textContent="Charging Up"; fomo.style.color="var(--accent)"; fsub.textContent="Regime building. Waiting for breakout."; }
    }

    async function fetchState(){
      try{
        const res = await fetch(`${API_BASE}/api/state`, { cache:"no-store" });
        if(!res.ok) throw new Error(`API ${res.status}`);
        const data = await res.json();
        if (!data || !data.series || !data.series.t) return;

        const now = data.now || {};
        const cfg = data.config || {};
        updateMeta(now, cfg);
        updateCharts(data.series || {}, now);
        updateRevenue(data.revenue || {});
      } catch(e){
        console.error("fetchState failed", e);
      }
    }

    initCharts();
    fetchState();
    setInterval(fetchState, 1000);
  </script>
</body>
</html>
